<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste de Pr√©-Processamento OCR</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .main-container {
            max-width: 1400px;
            margin: 0 auto;
        }
        .card {
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            margin-bottom: 20px;
        }
        .card-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px 15px 0 0 !important;
            padding: 20px;
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            padding: 10px 30px;
            border-radius: 25px;
            transition: all 0.3s;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        .btn-success {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            border: none;
            border-radius: 25px;
        }
        .image-preview {
            max-width: 100%;
            height: auto;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            margin: 10px 0;
        }
        .image-container {
            text-align: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            margin: 10px 0;
        }
        .options-panel {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }
        .form-check {
            margin: 10px 0;
        }
        .result-section {
            margin-top: 30px;
        }
        .metadata-card {
            background: #e9ecef;
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
        }
        .loading {
            display: none;
        }
        .loading.active {
            display: block;
        }
        .error-message {
            background: #ffebee;
            color: #c62828;
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
            border-left: 4px solid #c62828;
        }
        .success-message {
            background: #e8f5e9;
            color: #2e7d32;
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
            border-left: 4px solid #2e7d32;
        }
    </style>
</head>
<body>
    <div class="main-container">
        <div class="card">
            <div class="card-header">
                <h2><i class="bi bi-image"></i> Teste de Pr√©-Processamento OCR</h2>
                <p class="mb-0">Upload de documento para testar pr√©-processamento de imagens</p>
            </div>
            <div class="card-body">
                <form id="preprocessingForm" enctype="multipart/form-data">
                    <div class="mb-3">
                        <label for="fileInput" class="form-label">Selecione um arquivo (PDF ou imagem)</label>
                        <input type="file" class="form-control" id="fileInput" name="file" accept=".pdf,.jpg,.jpeg,.png,.bmp,.tiff" required>
                        <div class="form-text">Formatos aceitos: PDF, JPG, JPEG, PNG, BMP, TIFF</div>
                    </div>

                    <div class="options-panel">
                        <h5><i class="bi bi-sliders"></i> Op√ß√µes de Pr√©-Processamento</h5>
                        
                        <div class="mb-3">
                            <label for="presetMode" class="form-label">Modo de Preset:</label>
                            <select class="form-select" id="presetMode" name="preset_mode">
                                <option value="mistral" selected>Mistral (Recomendado)</option>
                                <option value="none">Nenhum (Sem pr√©-processamento)</option>
                                <option value="custom">Personalizado</option>
                            </select>
                        </div>

                        <div id="customOptions" style="display: none;">
                            <h6>Op√ß√µes Personalizadas:</h6>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="applyClahe" name="apply_clahe" value="true">
                                <label class="form-check-label" for="applyClahe">
                                    CLAHE (Equaliza√ß√£o de Histograma Adaptativa)
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="applyDenoise" name="apply_denoise" value="true">
                                <label class="form-check-label" for="applyDenoise">
                                    Remo√ß√£o de Ru√≠do (Filtro Bilateral)
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="applyDeskew" name="apply_deskew" value="true">
                                <label class="form-check-label" for="applyDeskew">
                                    Corre√ß√£o de Inclina√ß√£o (Deskew)
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="applyAutocrop" name="apply_autocrop" value="true">
                                <label class="form-check-label" for="applyAutocrop">
                                    Auto Crop (Recorte Autom√°tico)
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="applyBinarization" name="apply_binarization" value="true">
                                <label class="form-check-label" for="applyBinarization">
                                    Binariza√ß√£o (Preto e Branco)
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="applySharpen" name="apply_sharpen" value="true">
                                <label class="form-check-label" for="applySharpen">
                                    Nitidez (Sharpening)
                                </label>
                            </div>
                        </div>
                    </div>

                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-primary btn-lg" id="processBtn">
                            <i class="bi bi-play-fill"></i> Processar Documento
                        </button>
                        <button type="button" class="btn btn-secondary btn-lg" onclick="window.location.href='/'">
                            <i class="bi bi-house-fill"></i> Voltar
                        </button>
                    </div>
                </form>
                
                <div class="alert alert-info mt-3" role="alert">
                    <h6><i class="bi bi-info-circle-fill"></i> Dicas de Uso:</h6>
                    <ul class="mb-0">
                        <li>Use o modo <strong>Mistral</strong> para melhor qualidade OCR</li>
                        <li>Para documentos simples, o modo <strong>Nenhum</strong> pode ser mais r√°pido</li>
                        <li>Verifique o <strong>Console do Navegador</strong> (F12) para logs detalhados</li>
                        <li>Os logs do servidor aparecem no terminal onde o app est√° rodando</li>
                    </ul>
                </div>

                <div class="loading" id="loadingDiv">
                    <div class="text-center mt-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Processando...</span>
                        </div>
                        <p class="mt-3">Processando documento...</p>
                    </div>
                </div>

                <div id="errorDiv" class="error-message" style="display: none;"></div>
                <div id="successDiv" class="success-message" style="display: none;"></div>

                <div id="resultsDiv" class="result-section" style="display: none;">
                    <h4 class="mt-4"><i class="bi bi-images"></i> Resultados</h4>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="image-container">
                                <h5>Imagem Original</h5>
                                <img id="originalImage" class="image-preview" src="" alt="Imagem Original">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="image-container">
                                <h5>Imagem Processada</h5>
                                <img id="processedImage" class="image-preview" src="" alt="Imagem Processada">
                            </div>
                        </div>
                    </div>

                    <div class="metadata-card">
                        <h5><i class="bi bi-info-circle"></i> Metadados do Processamento</h5>
                        <pre id="metadataContent" class="mb-0"></pre>
                    </div>

                    <div class="card mt-3">
                        <div class="card-header">
                            <h5><i class="bi bi-file-text"></i> Texto OCR Extra√≠do</h5>
                        </div>
                        <div class="card-body">
                            <textarea id="ocrText" class="form-control" rows="10" readonly></textarea>
                            <button class="btn btn-sm btn-secondary mt-2" onclick="copyOCRText()">
                                <i class="bi bi-clipboard"></i> Copiar Texto
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Mostrar/ocultar op√ß√µes personalizadas
        document.getElementById('presetMode').addEventListener('change', function() {
            const customOptions = document.getElementById('customOptions');
            if (this.value === 'custom') {
                customOptions.style.display = 'block';
            } else {
                customOptions.style.display = 'none';
            }
        });

        function stripHtmlTags(html) {
            if (!html) return '';
            // Remove todas as tags HTML de forma simples, sem inserir no DOM
            return String(html).replace(/<[^>]*>/g, '');
        }

        // Manipular envio do formul√°rio
        document.getElementById('preprocessingForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const loadingDiv = document.getElementById('loadingDiv');
            const errorDiv = document.getElementById('errorDiv');
            const successDiv = document.getElementById('successDiv');
            const resultsDiv = document.getElementById('resultsDiv');
            const processBtn = document.getElementById('processBtn');
            
            // Resetar UI
            loadingDiv.classList.add('active');
            errorDiv.style.display = 'none';
            successDiv.style.display = 'none';
            resultsDiv.style.display = 'none';
            processBtn.disabled = true;
            
            try {
                const response = await fetch('/api/teste-preprocessing', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                // Debug: mostrar resposta no console
                console.log('üì• Resposta da API:', data);
                console.log('üìù Texto original:', data.texto_original?.substring(0, 100) + '...');
                console.log('üîí Texto mascarado:', data.texto_mascarado?.substring(0, 100) + '...');
                
                loadingDiv.classList.remove('active');
                processBtn.disabled = false;
                
                if (!response.ok) {
                    throw new Error(data.message || data.error || 'Erro ao processar documento');
                }
                
                if (data.success) {
                    // Mostrar resultados
                    successDiv.textContent = `‚úì Processamento conclu√≠do com sucesso! Tempo: ${data.processing_time || 'N/A'}s`;
                    successDiv.style.display = 'block';
                    
                    // Exibir imagens
                    if (data.original_image) {
                        document.getElementById('originalImage').src = data.original_image;
                    }
                    if (data.processed_image) {
                        document.getElementById('processedImage').src = data.processed_image;
                    }
                    
                    // Exibir metadados
                    if (data.metadata) {
                        let metadataText = JSON.stringify(data.metadata, null, 2);
                        
                        // Adicionar estat√≠sticas de mascaramento se dispon√≠veis
                        if (data.masked_stats) {
                            metadataText += "\n\n" + "=".repeat(40) + "\n";
                            metadataText += "üìä ESTAT√çSTICAS DE MASCARAMENTO\n";
                            metadataText += "=".repeat(40) + "\n";
                            metadataText += `Total de dados mascarados: ${data.masked_stats.total_masked}\n\n`;
                            metadataText += "Por tipo:\n";
                            for (const [tipo, count] of Object.entries(data.masked_stats.by_type)) {
                                if (count > 0) {
                                    metadataText += `  - ${tipo}: ${count}\n`;
                                }
                            }
                        }
                        
                        document.getElementById('metadataContent').textContent = metadataText;
                    }
                    
                    // Exibir texto OCR
                    console.log('üîç Verificando textos dispon√≠veis...');
                    console.log('   - texto_original existe?', !!data.texto_original);
                    console.log('   - texto_original length:', data.texto_original?.length || 0);
                    console.log('   - texto_mascarado existe?', !!data.texto_mascarado);
                    console.log('   - texto_mascarado length:', data.texto_mascarado?.length || 0);
                    
                    let textoOCR = '';
                    
                    // Verificar se h√° texto original
                    if (data.texto_original && data.texto_original.trim().length > 0) {
                        console.log('‚úÖ Usando texto_original');
                        textoOCR = data.texto_original;
                        
                        // Se houver texto mascarado diferente, adicionar se√ß√£o separada
                        if (data.texto_mascarado && data.texto_mascarado !== data.texto_original) {
                            console.log('‚ÑπÔ∏è Adicionando tamb√©m texto_mascarado');
                            // Remover tags HTML do texto mascarado para exibi√ß√£o, sem usar innerHTML
                            const textoMascaradoLimpo = stripHtmlTags(data.texto_mascarado);
                            
                            textoOCR = "========== TEXTO ORIGINAL ==========\n\n" + 
                                       data.texto_original + 
                                       "\n\n\n========== TEXTO MASCARADO (DADOS SENS√çVEIS OCULTOS) ==========\n\n" + 
                                       textoMascaradoLimpo;
                        }
                    } 
                    // Fallback para texto mascarado se n√£o houver original
                    else if (data.texto_mascarado && data.texto_mascarado.trim().length > 0) {
                        console.log('‚ö†Ô∏è Usando texto_mascarado (texto_original n√£o dispon√≠vel)');
                        // Remover tags HTML sem usar innerHTML
                        textoOCR = stripHtmlTags(data.texto_mascarado);
                    }
                    
                    // Exibir no textarea
                    if (textoOCR && textoOCR.trim().length > 0) {
                        console.log(`‚úÖ Exibindo ${textoOCR.length} caracteres de texto OCR`);
                        document.getElementById('ocrText').value = textoOCR;
                    } else {
                        console.error('‚ùå Nenhum texto OCR dispon√≠vel!');
                        document.getElementById('ocrText').value = '‚ö†Ô∏è ERRO: Nenhum texto foi extra√≠do pela OCR.\n\n' +
                            'Poss√≠veis causas:\n' +
                            '- O documento pode estar em branco\n' +
                            '- A qualidade da imagem pode estar muito baixa\n' +
                            '- O OCR pode ter falhado\n\n' +
                            'Verifique o console do navegador e os logs do servidor para mais detalhes.';
                    }
                    
                    resultsDiv.style.display = 'block';
                    
                    // Scroll para resultados
                    resultsDiv.scrollIntoView({ behavior: 'smooth' });
                } else {
                    throw new Error(data.message || data.error || 'Erro desconhecido');
                }
            } catch (error) {
                errorDiv.textContent = `‚ùå Erro: ${error.message}`;
                errorDiv.style.display = 'block';
            }
        });

        function copyOCRText() {
            const ocrText = document.getElementById('ocrText');
            ocrText.select();
            document.execCommand('copy');
            alert('Texto copiado para a √°rea de transfer√™ncia!');
        }
    </script>
</body>
</html>
